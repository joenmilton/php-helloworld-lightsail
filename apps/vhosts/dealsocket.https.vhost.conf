<VirtualHost *:443>
  ServerName socket.techyline.com

  SSLEngine on
  SSLCertificateFile "/etc/letsencrypt/live/socket.techyline.com/fullchain.pem"
  SSLCertificateKeyFile "/etc/letsencrypt/live/socket.techyline.com/privkey.pem"

  # Ensure needed Apache modules are enabled:
  # - proxy
  # - proxy_http
  # - proxy_wstunnel
  # - ssl
  # (Bitnami usually has them pre-enabled)

  # Allow WebSocket connections (proxy to Node.js)
  ProxyPreserveHost On
  ProxyRequests Off

  # WebSocket support
  ProxyPass "/socket.io/" "http://127.0.0.1:3001/socket.io/"
  ProxyPassReverse "/socket.io/" "http://127.0.0.1:3001/socket.io/"

  # Fallback for other HTTP requests
  ProxyPass "/" "http://127.0.0.1:3001/"
  ProxyPassReverse "/" "http://127.0.0.1:3001/"

  # Required for WebSocket upgrade
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule /(.*) ws://127.0.0.1:3001/$1 [P,L]

  RewriteCond %{HTTP:Upgrade} !=websocket [NC]
  RewriteRule /(.*) http://127.0.0.1:3001/$1 [P,L]

  <Proxy *>
    Require all granted
  </Proxy>
</VirtualHost>
